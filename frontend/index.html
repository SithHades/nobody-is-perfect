<!DOCTYPE html>
<html>
<head>
  <title>Nobody is Perfect</title>
</head>
<body>
  <div id="login">
    Password: <input type="password" id="password"><br>
    Name: <input type="text" id="name"><br>
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>
  <div id="game" style="display:none;">
    <p>Users: <span id="userList"></span></p>
    <p>Game Master: <span id="gameMaster"></span></p>
    <div id="playerView" style="display:none;">
      <input type="text" id="sentence" placeholder="Write your sentence">
      <button onclick="submitSentence()">Submit</button>
      <p id="playerStatus"></p>
    </div>
    <div id="gmView" style="display:none;">
      <button onclick="stopGame()">STOP</button>
      <button onclick="doneGame()">DONE</button>
      <button onclick="resetGame()">RESET ALL</button>
      <p>Sentences:</p>
      <ul id="sentenceList"></ul>
    </div>
    <p id="status"></p>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('https://nip-backend.kncklab.com');
    let myName;
    let isGameMaster = false;

    function login() {
      const password = document.getElementById('password').value;
      const name = document.getElementById('name').value;
      if (!name || name.trim() === '') {
        document.getElementById('loginError').innerText = 'Please enter a name';
        return;
      }
      console.log('Attempting login:', { password, name });
      socket.emit('login', { password, name });
    }

    socket.on('connect', () => console.log('Connected to backend'));

    socket.on('loginSuccess', (data) => {
      myName = document.getElementById('name').value;
      document.getElementById('login').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      updateUI(data);
    });

    socket.on('loginFailed', () => {
      document.getElementById('loginError').innerText = 'Wrong password or name taken';
    });

    socket.on('updateUsers', (data) => updateUI(data));

    socket.on('newSentence', (data) => {
      console.log('New sentence received:', data);
      if (isGameMaster) {
        console.log('I am the GM, updating sentence list');
        const li = document.createElement('li');
        li.innerText = `${data.name}: ${data.sentence}`;
        document.getElementById('sentenceList').appendChild(li);
      }
    });

    socket.on('gameStopped', () => {
      document.getElementById('status').innerText = 'Game stopped';
      document.getElementById('sentence').disabled = true;
    });

    socket.on('newGameMaster', (data) => {
      updateUI(data);
      document.getElementById('sentence').value = '';
      document.getElementById('sentenceList').innerHTML = '';
      document.getElementById('status').innerText = 'New round started';
      document.getElementById('playerStatus').innerText = '';
    });

    socket.on('gameReset', () => {
      document.getElementById('game').style.display = 'none';
      document.getElementById('login').style.display = 'block';
      document.getElementById('sentence').value = '';
      document.getElementById('sentenceList').innerHTML = '';
      document.getElementById('status').innerText = 'Game reset';
      document.getElementById('playerStatus').innerText = '';
      myName = null;
      isGameMaster = false;
    });

    socket.on('sentenceSubmitted', () => {
      document.getElementById('playerStatus').innerText = 'Your sentence has been submitted';
    });

    function resetGame() {
      socket.emit('resetGame');
    }

    function updateUI(data) {
      console.log('Updating UI:', data);
      document.getElementById('userList').innerText = data.users.join(', ');
      document.getElementById('gameMaster').innerText = data.gameMaster;
      
      isGameMaster = myName === data.gameMaster;
      
      document.getElementById('playerView').style.display = isGameMaster ? 'none' : 'block';
      document.getElementById('gmView').style.display = isGameMaster ? 'block' : 'none';
      document.getElementById('sentence').disabled = false;
      
      // If game master changes, clear sentence list
      if (isGameMaster) {
        document.getElementById('sentenceList').innerHTML = '';
        
        // Load existing sentences if there are any
        if (data.sentences) {
          Object.entries(data.sentences).forEach(([name, sentence]) => {
            const li = document.createElement('li');
            li.innerText = `${name}: ${sentence}`;
            document.getElementById('sentenceList').appendChild(li);
          });
        }
      }
    }
    
    function submitSentence() {
      const sentence = document.getElementById('sentence').value;
      if (sentence && sentence.trim() !== '') {
        console.log('Submitting sentence:', sentence);
        socket.emit('submitSentence', sentence);
        document.getElementById('sentence').disabled = true;
      }
    }

    function stopGame() {
      if (isGameMaster) {
        socket.emit('stopGame');
      }
    }

    function doneGame() {
      if (isGameMaster) {
        socket.emit('doneGame');
      }
    }
  </script>
</body>
</html>